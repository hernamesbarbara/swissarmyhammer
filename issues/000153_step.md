# Step 153: Add MCP Tool Definitions for Issue Operations

## Goal
Extend the MCP server to include tool definitions for all issue management operations, with clear descriptions and proper request/response structures.

## Implementation Details

### 1. Define MCP Request Structures
In `swissarmyhammer/src/mcp.rs`, add:

```rust
/// Request to create a new issue
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct CreateIssueRequest {
    /// Name of the issue (will be used in filename)
    pub name: String,
    /// Markdown content of the issue
    pub content: String,
}

/// Request to mark an issue as complete
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct MarkCompleteRequest {
    /// Issue number to mark as complete
    pub number: u32,
}

/// Request to check if all issues are complete
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct AllCompleteRequest {
    // No parameters needed
}

/// Request to update an issue
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct UpdateIssueRequest {
    /// Issue number to update
    pub number: u32,
    /// New markdown content for the issue
    pub content: String,
}

/// Request to get current issue
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct CurrentIssueRequest {
    /// Which branch to check (optional, defaults to current)
    pub branch: Option<String>,
}

/// Request to work on an issue
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct WorkIssueRequest {
    /// Issue number to work on
    pub number: u32,
}

/// Request to merge an issue
#[derive(Debug, Deserialize, schemars::JsonSchema)]
pub struct MergeIssueRequest {
    /// Issue number to merge
    pub number: u32,
}
```

### 2. Update McpServer Structure
```rust
use crate::issues::{FileSystemIssueStorage, IssueStorage};
use crate::git::GitOperations;

pub struct McpServer {
    library: Arc<RwLock<PromptLibrary>>,
    workflow_storage: Arc<RwLock<WorkflowStorage>>,
    file_watcher: Arc<Mutex<FileWatcher>>,
    issue_storage: Arc<RwLock<Box<dyn IssueStorage>>>,  // Add this
    git_ops: Arc<Mutex<GitOperations>>,  // Add this
}
```

### 3. Update McpServer Initialization
```rust
impl McpServer {
    pub fn new(library: PromptLibrary) -> Result<Self> {
        // ... existing initialization ...
        
        // Initialize issue storage
        let issue_storage = Box::new(FileSystemIssueStorage::new()?) 
            as Box<dyn IssueStorage>;
        
        // Initialize git operations
        let git_ops = GitOperations::new()?;
        
        Ok(Self {
            library: Arc::new(RwLock::new(library)),
            workflow_storage: Arc::new(RwLock::new(workflow_storage)),
            file_watcher: Arc::new(Mutex::new(FileWatcher::new())),
            issue_storage: Arc::new(RwLock::new(issue_storage)),
            git_ops: Arc::new(Mutex::new(git_ops)),
        })
    }
}
```

### 4. Register Tools in ServerHandler
Update the `list_tools` method in ServerHandler implementation:

```rust
async fn list_tools(
    &self,
    _request: Option<PaginatedRequestParam>,
    _context: RequestContext<RoleServer>,
) -> std::result::Result<ListToolsResult, McpError> {
    let tools = vec![
        // ... existing workflow tools ...
        
        Tool {
            name: "issue_create".to_string(),
            description: Some("Create a new issue with auto-assigned number. Issues are markdown files stored in ./issues directory for tracking work items.".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(CreateIssueRequest)
            ).ok(),
        },
        
        Tool {
            name: "issue_mark_complete".to_string(),
            description: Some("Mark an issue as complete by moving it to ./issues/complete directory.".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(MarkCompleteRequest)
            ).ok(),
        },
        
        Tool {
            name: "issue_all_complete".to_string(),
            description: Some("Check if all issues are completed. Returns true if no pending issues remain.".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(AllCompleteRequest)
            ).ok(),
        },
        
        Tool {
            name: "issue_update".to_string(),
            description: Some("Update the content of an existing issue with additional context or modifications.".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(UpdateIssueRequest)
            ).ok(),
        },
        
        Tool {
            name: "issue_current".to_string(),
            description: Some("Get the current issue being worked on. Checks branch name to identify active issue.".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(CurrentIssueRequest)
            ).ok(),
        },
        
        Tool {
            name: "issue_work".to_string(),
            description: Some("Switch to a work branch for the specified issue (creates branch issue/<issue_name> if needed).".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(WorkIssueRequest)
            ).ok(),
        },
        
        Tool {
            name: "issue_merge".to_string(),
            description: Some("Merge the work branch for an issue back to the main branch.".to_string()),
            input_schema: serde_json::to_value(
                schemars::schema_for!(MergeIssueRequest)
            ).ok(),
        },
    ];
    
    Ok(ListToolsResult {
        tools,
        next_cursor: None,
    })
}
```

### 5. Update Server Instructions
Update the server instructions to mention issue tracking:

```rust
instructions: Some("A flexible prompt and workflow management server with integrated issue tracking. Use list_prompts to see available prompts and get_prompt to retrieve and render them. Use workflow tools to execute and manage workflows. Use issue_* tools to create and manage work items tracked as markdown files in your repository.".into()),
```

## Testing
- Test that all tools appear in list_tools response
- Test schema generation for each request type
- Verify tool descriptions are clear and helpful

## Success Criteria
- All issue tools are registered and visible to MCP clients
- Request schemas are properly generated
- Tool descriptions clearly explain their purpose
- Server initializes with issue storage and git operations